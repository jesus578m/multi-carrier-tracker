<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>Rastreador Multi-Paquetería</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; max-width: 900px; }
      h1 { margin: 0 0 16px; }
      .card { border: 1px solid rgba(0,0,0,.1); border-radius: 12px; padding: 16px; margin: 12px 0; }
      .row { display: grid; grid-template-columns: 180px 1fr; gap: 12px; align-items: center; margin: 8px 0; }
      input, select, button { padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,.2); font-size: 15px; }
      button { cursor: pointer; }
      .result { white-space: pre-wrap; }
      .muted { opacity: .7; font-size: 12px; }
      .kv { margin: 4px 0; }
      .kv span { display: inline-block; min-width: 160px; font-weight: 600; }
      .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      a.button { text-decoration: none; display: inline-block; }
    </style>
  </head>
  <body>
    <h1>Rastreador Multi-Paquetería</h1>
    <div class="card">
      <div class="row">
        <label>Paquetería</label>
        <select id="carrier">
          <option value="dhl">DHL</option>
          <option value="fedex">FedEx</option>
          <option value="ups">UPS</option>
          <option value="delta">Delta Cargo</option>
          <option value="expeditors">Expeditors</option>
        </select>
      </div>
      <div class="row">
        <label>Número/Guía</label>
        <input id="code" placeholder="Ingresa tu guía o AWB" />
      </div>
      <div class="row">
        <label></label>
        <button id="btn">Consultar</button>
      </div>
      <div id="out" class="result"></div>
    </div>

    <p class="muted">
      * Se usa información pública de las páginas oficiales. Si no es posible extraer la información automáticamente, se incluye el enlace oficial como respaldo.
    </p>

    <script>
      const $ = (s) => document.querySelector(s);
      function line(k, v) {
        if (!v) return "";
        const div = document.createElement("div");
        div.className = "kv";
        div.innerHTML = `<span>${k}:</span> ${v}`;
        return div;
      }

      $("#btn").addEventListener("click", async () => {
        const carrier = $("#carrier").value.trim();
        const code = $("#code").value.trim();
        $("#out").textContent = "Consultando...";
        try {
          const r = await fetch("/api/track", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ carrier, code })
          });
          const json = await r.json();
          if (!json.ok) {
            $("#out").textContent = "Error: " + (json.error || "desconocido");
            return;
          }

          const frag = document.createDocumentFragment();
          frag.appendChild(line("Paquetería", json.carrier?.toUpperCase()));
          frag.appendChild(line("Guía", json.code));
          frag.appendChild(line("Estado", json.status));
          frag.appendChild(line("Entrega estimada", json.eta));
          frag.appendChild(line("Entregado el", json.deliveredAt));
          frag.appendChild(line("Firmado por", json.signedBy));
          frag.appendChild(line("Origen", json.origin));
          frag.appendChild(line("Destino", json.destination));

          const divBtn = document.createElement("div");
          divBtn.className = "flex";
          const a = document.createElement("a");
          a.href = json.officialUrl;
          a.target = "_blank";
          a.rel = "noopener";
          a.className = "button";
          a.innerHTML = "<button>Abrir página oficial</button>";
          divBtn.appendChild(a);

          $("#out").innerHTML = "";
          $("#out").appendChild(frag);
          if (!json.status && !json.eta && !json.deliveredAt) {
            // Si no pudimos extraer nada, deja explícito el botón
            $("#out").appendChild(divBtn);
          }
        } catch (e) {
          $("#out").textContent = "Falló la consulta. Intenta de nuevo.";
        }
      });
    </script>
  </body>
</html>
